name: King_of_Hearts_Original_Names # تم تصحيح الحرف الأول إلى n صغيرة

on:
  schedule:
    - cron: '0 */4 * * *' 
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests 

      - name: Smart Filter & Decade Blocks
        shell: python
        run: |
          import requests
          import re
          from datetime import datetime, timedelta

          url = "https://raw.githubusercontent.com/miladtahanian/Config-Collector/main/mixed_iran.txt"
          hosts = ["viberout-lp.viber.com", "lp.viber.com", "braze-images.com", "cdn.braze.com"]
          
          try:
              response = requests.get(url, timeout=30)
              response.raise_for_status()
              # تنقية السيرفرات (بورت 443 و 80 فقط للعراق)
              lines = [l for l in list(set(response.text.splitlines())) if ":443" in l or ":80" in l]
              
              final_output = []
              # تطبيق نظام المجموعات العشرية (كل 10 سيرفرات بهوست)
              for i, config in enumerate(lines[:120]):
                  host_index = (i // 10) % len(hosts)
                  selected_host = hosts[host_index]
                  # حقن الهوست الجديد
                  new_config = re.sub(r'@[^:]+:', f'@{selected_host}:', config)
                  final_output.append(new_config)

              timestamp = (datetime.utcnow() + timedelta(hours=3)).strftime('%Y-%m-%d %I:%M %p')
              with open("king_of_hearts.txt", "w") as f:
                  f.write(f"###############################################\n")
                  f.write(f"# BRAND: King of Hearts (Decade Blocks)\n")
                  f.write(f"# UPDATE: {timestamp} (BAGHDAD)\n")
                  f.write(f"###############################################\n\n")
                  f.write("\n".join(final_output))
          except Exception as e:
              print(f"Error: {e}")

      - name: Commit and Push
        run: |
          git config --global user.name "Ghazwan-Pro-Lab"
          git config --global user.email "lab@ghazwan.pro"
          git add king_of_hearts.txt
          git commit -m "Fixing Syntax and Updating Blocks" || exit 0
          git push
