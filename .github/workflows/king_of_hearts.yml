name: King_of_Hearts_Original_Names

on:
  schedule:
    - cron: '0 */4 * * *' # تحديث كل 4 ساعات
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests # تثبيت المكتبة الناقصة لضمان عدم الفشل

      - name: Smart Filter (Original Names - Port 443/80)
        shell: python
        run: |
          import requests
          import base64
          import json
          import os
          from datetime import datetime, timedelta

          url = "https://raw.githubusercontent.com/miladtahanian/Config-Collector/main/mixed_iran.txt"
          
          try:
              response = requests.get(url, timeout=30)
              response.raise_for_status() # التأكد من أن الرابط شغال
              lines = response.text.splitlines()
              final_configs = []

              for line in lines:
                  # فحص Trojan و Vless
                  if "trojan://" in line or "vless://" in line:
                      if ":443" in line or ":80" in line:
                          final_configs.append(line)

                  # فحص Vmess المشفر
                  elif "vmess://" in line:
                      try:
                          b64_data = line.replace("vmess://", "")
                          decoded = base64.b64decode(b64_data + '=' * (-len(b64_data) % 4)).decode('utf-8')
                          config_json = json.loads(decoded)
                          if str(config_json.get('port')) in ['443', '80']:
                              final_configs.append(line)
                      except:
                          continue

              # كتابة الملف النهائي
              timestamp = (datetime.utcnow() + timedelta(hours=3)).strftime('%Y-%m-%d %I:%M %p')
              with open("king_of_hearts.txt", "w") as f:
                  f.write("###############################################\n")
                  f.write("# SOURCE: MILAD SOURCE (ORIGINAL NAMES)\n")
                  f.write("# STATUS: VMESS/VLESS/TROJAN | PORT 443/80\n")
                  f.write(f"# UPDATE: {timestamp}\n")
                  f.write("###############################################\n\n")
                  f.write("\n".join(list(set(final_configs))))
          except Exception as e:
              print(f"Failed to fetch data: {e}")

      - name: Commit and Push
        run: |
          git config --global user.name "Ghazwan-Pro-Lab"
          git config --global user.email "lab@ghazwan.pro"
          git add king_of_hearts.txt
          git commit -m "Auto Update: King of Hearts Full Protocols" || exit 0
          git push
