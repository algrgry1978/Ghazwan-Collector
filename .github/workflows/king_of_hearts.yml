Name: King_of_Hearts_Original_Names

on:
  schedule:
    - cron: '0 */4 * * *' 
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: # حل مشكلة الفشل: إضافة صلاحيات الكتابة
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests 

      - name: Smart Filter & Decade Blocks
        shell: python
        run: |
          import requests
          import base64
          import json
          import os
          import re
          from datetime import datetime, timedelta

          url = "https://raw.githubusercontent.com/miladtahanian/Config-Collector/main/mixed_iran.txt"
          hosts = ["viberout-lp.viber.com", "lp.viber.com", "braze-images.com", "cdn.braze.com"]
          
          try:
              response = requests.get(url, timeout=30)
              response.raise_for_status()
              lines = list(set(response.text.splitlines())) # إزالة التكرار فوراً
              filtered_configs = []

              for line in lines:
                  # فحص بورت 443 و 80 لضمان العمل في العراق
                  if ":443" in line or ":80" in line:
                      if any(proto in line for proto in ["vless://", "trojan://", "vmess://"]):
                          filtered_configs.append(line)

              # تطبيق نظام المجموعات العشرية (10 سيرفرات لكل هوست)
              final_output = []
              for i, config in enumerate(filtered_configs[:100]): # معالجة أول 100 سيرفر فقط لضمان القوة
                  host_index = (i // 10) % len(hosts) # تغيير الهوست كل 10 سيرفرات
                  selected_host = hosts[host_index]
                  
                  # عملية حقن الهوست (Injection)
                  new_config = re.sub(r'@[^:]+:', f'@{selected_host}:', config)
                  final_output.append(new_config)

              # كتابة الملف النهائي بتوقيت بغداد
              timestamp = (datetime.utcnow() + timedelta(hours=3)).strftime('%Y-%m-%d %I:%M %p')
              with open("king_of_hearts.txt", "w") as f:
                  f.write("###############################################\n")
                  f.write("# BRAND: King of Hearts (Titanium Edition)\n")
                  f.write("# MODE: 10-Server Decade Blocks\n")
                  f.write(f"# UPDATE: {timestamp} (BAGHDAD)\n")
                  f.write("###############################################\n\n")
                  f.write("\n".join(final_output))
          except Exception as e:
              print(f"Error: {e}")

      - name: Commit and Push
        run: |
          git config --global user.name "Ghazwan-Pro-Lab"
          git config --global user.email "lab@ghazwan.pro"
          git add king_of_hearts.txt
          # حل مشكلة الفشل: منع التوقف إذا لم يوجد تغيير
          git commit -m "Titanium King Update: $TIMESTAMP" || exit 0
          git push || echo "Push failed but action finished"
