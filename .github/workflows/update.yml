name: Ghazwan Only-Address Injection

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Inject Host into Address Field Only
        run: |
          # 1. جمع السيرفرات العالمية
          curl -sL "https://raw.githubusercontent.com/barry-far/V2ray-Config/main/All_Configs_Sub.txt" > raw_data.txt
          curl -sL "https://raw.githubusercontent.com/MahdiHoseinZade/V2rayCollector/main/sub/sub_merge.txt" >> raw_data.txt
          
          # 2. تنظيف وفلترة (حذف SS وإبقاء 443/80)
          grep -E ":443|:80" raw_data.txt | grep -v "^ss://" | sort -u > clean_data.txt

          # 3. تفريغ الملف القديم للبدء بالحقن الجديد
          echo "# Last Update: $(date)" > mysubs.txt

          # 4. عملية استبدال العنوان (Address) فقط مع الحفاظ على الباقي
          # سيتم تقسيم السيرفرات على هوستاتك الخمسة بالتساوي
          
          # Viberout-lp.viber.com
          sed -E 's/@[^:]+:/@Viberout-lp.viber.com:/g' clean_data.txt | head -n 200 >> mysubs.txt
          
          # lp.viber.com
          sed -E 's/@[^:]+:/@lp.viber.com:/g' clean_data.txt | sed -n '201,400p' >> mysubs.txt
          
          # braze-images.com
          sed -E 's/@[^:]+:/@braze-images.com:/g' clean_data.txt | sed -n '401,600p' >> mysubs.txt
          
          # cdn.braze.com
          sed -E 's/@[^:]+:/@cdn.braze.com:/g' clean_data.txt | sed -n '601,800p' >> mysubs.txt
          
          # go.braze.com
          sed -E 's/@[^:]+:/@go.braze.com:/g' clean_data.txt | sed -n '801,1000p' >> mysubs.txt

      - name: Push Changes
        run: |
          git config --global user.name "Ghazwan-Pro"
          git config --global user.email "ghazwan@pro.com"
          git add mysubs.txt
          git diff --quiet && git diff --staged --quiet || (git commit -m "Only Address Injected" && git push)
