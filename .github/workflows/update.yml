name: Professional Port-Specific Collector

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch, Decode and Filter
        run: |
          # إنشاء ترويسة الملف
          echo "# Professional Server List - Ports 443 & 80 Only" > mysubs.txt
          echo "# Project: Baby House - Optimized by Ghazwan Al-Jarjari" >> mysubs.txt
          
          # جلب البيانات وفك تشفيرها (Base64) ثم البحث عن المنافذ
          sources=(
            "https://shz.al/~WangCai"
            "https://b2n.ir/v2ray-configs"
            "https://raw.githubusercontent.com/yebekhe/vpn-fail/main/sub-link"
            "https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/v2ray/super-sub.txt"
          )

          for url in "${sources[@]}"; do
            # جلب المحتوى وفك التشفير إذا كان Base64، ثم البحث عن المنافذ المطلوبة
            curl -sL "$url" | base64 -d 2>/dev/null | grep -E ":443|:80" >> mysubs.txt || \
            curl -sL "$url" | grep -E ":443|:80" >> mysubs.txt
          done

          # تنظيف الملف من التكرار
          sort -u mysubs.txt -o mysubs.txt
          echo "# Updated by Ghazwan Al-Jarjari Factory" >> mysubs.txt

      - name: Commit and Push
        run: |
          git config --global user.name "Ghazwan-Designer"
          git config --global user.email "ghazwan@example.com"
          git add mysubs.txt
          git diff --quiet && git diff --staged --quiet || (git commit -m "Advanced Port-Filtered Sync" && git push)
