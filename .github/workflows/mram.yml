name: Iraq_Elite_Titanium_Optimized

on:
  schedule:
    - cron: '0 */4 * * *' # تحديث تلقائي كل 4 ساعات
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests # حل مشكلة الفشل في 4 ثوانٍ

      - name: Smart Collector (Large Source Handling)
        shell: python
        run: |
          import requests, base64, json, re
          from datetime import datetime, timedelta

          # الرابط الضخم الذي وجدته مع مصادرك الأخرى
          urls = [
              "https://raw.githubusercontent.com/yebekhe/TVip/main/Sub/v2ray.txt",
              "https://raw.githubusercontent.com/tina-v2ray/V2Ray-Config/main/All_Configs_Sub.txt",
              "https://raw.githubusercontent.com/MahdiHoseinZade/V2rayCollector/main/sub/sub_merge.txt"
          ]

          hosts = ["viberout-lp.viber.com", "lp.viber.com", "braze-images.com", "cdn.braze.com"]
          final_configs = []

          def decode_data(data):
              try:
                  return base64.b64decode(data + '=' * (-len(data) % 4)).decode('utf-8')
              except: return data

          for url in urls:
              try:
                  res = requests.get(url, timeout=30)
                  # فك تشفير الرابط الضخم ليتحول لأسطر واضحة
                  content = decode_data(res.text)
                  for line in content.splitlines():
                      if not line.strip(): continue
                      # فلترة البورتات المطلوبة للعراق
                      if (":443" in line or ":80" in line) and ("vless" in line or "trojan" in line or "vmess" in line):
                          final_configs.append(line)
              except: continue

          unique_configs = list(set(final_configs))
          
          # حقن الهوستات والاسم الرسمي
          injected = []
          for i, config in enumerate(unique_configs):
              h_idx = i % len(hosts)
              # تخصيص الاسم ليظهر Titanium_X
              if "#" in config: config = config.split("#")[0]
              injected.append(f"{config}#Titanium_{i}")

          # حفظ الملف النهائي
          timestamp = (datetime.utcnow() + timedelta(hours=3)).strftime('%Y-%m-%d %I:%M %p')
          with open("mysubs_new.txt", "w") as f:
              f.write(f"###############################################\n")
              f.write(f"# BRAND: Ghazwan_Pro_Titanium - FULL FLOW\n")
              f.write(f"# UPDATE: {timestamp}\n")
              f.write(f"###############################################\n\n")
              f.write("\n".join(injected))

      - name: Push to GitHub
        run: |
          git config --global user.name "Ghazwan-Pro-Lab"
          git config --global user.email "lab@ghazwan.pro"
          git add mysubs_new.txt
          git commit -m "Titanium Full Refresh: Source Expanded $TIMESTAMP" || exit 0
          git push
